version: '3.8'

services:
  # Continuous Crawler Service
  crawler_service:
    build:
      context: .
      dockerfile: crawler_service/Dockerfile
    container_name: tradesystem_crawler
    volumes:
      - ./crawler_service/data:/app/crawler_service/data
      - ./crawler_service/config:/app/crawler_service/config:ro
    environment:
      - PYTHONUNBUFFERED=1
      - CRAWLER_INTERVAL_MINUTES=30
      - LOG_LEVEL=INFO
    networks:
      - tradesystem_network
    restart: unless-stopped

  # Continuous Data Processor Service
  data_processor_service:
    build:
      context: ./data_processor_service
      dockerfile: Dockerfile
      args:
        BUILDKIT_STEP_LOG_MAX_SIZE: -1
        BUILDKIT_STEP_LOG_MAX_SPEED: -1
    container_name: tradesystem_processor
    volumes:
      - ./data_processor_service/final_predictions:/app/data_processor_service/final_predictions
      - ./data_processor_service/sentiment_results:/app/data_processor_service/sentiment_results
      - ./data_processor_service/financial_analysis_results:/app/data_processor_service/financial_analysis_results
      - ./data_processor_service/classified_articles:/app/data_processor_service/classified_articles
      - ./crawler_service/data:/app/crawler_service/data:ro
      - ./data_processor_service/final_predictions:/app/final_predictions
    environment:
      - PYTHONUNBUFFERED=1
      - PROCESSOR_CHECK_INTERVAL_SECONDS=30
      - LOG_LEVEL=DEBUG
      - REPROCESS_INTERVAL_MINUTES=1
      - CRAWLER_DATA_DIR=/app/crawler_service/data/by_company
    networks:
      - tradesystem_network
    restart: unless-stopped
    depends_on:
      - crawler_service

  # Market Data Service
  market_data_service:
    build:
      context: .
      dockerfile: market_data_service/Dockerfile
    container_name: tradesystem_market_data
    ports:
      - "8001:8001"
    volumes:
      - ./market_data_service/stock_data:/app/market_data_service/stock_data
    environment:
      - PYTHONUNBUFFERED=1
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      - PORT=8001
      - LOG_LEVEL=INFO
    networks:
      - tradesystem_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # API Service with WebSocket
  api_service:
    build:
      context: .
      dockerfile: api_service/Dockerfile
    container_name: tradesystem_api
    ports:
      - "8000:8000"
    volumes:
      - ./data_processor_service/final_predictions:/data_processor_service/final_predictions:ro
      - ./data_processor_service/sentiment_results:/app/data_processor_service/sentiment_results:ro
      - ./data_processor_service/financial_analysis_results:/app/data_processor_service/financial_analysis_results:ro
      - ./market_data_service/stock_data:/app/market_data_service/stock_data:ro
      - ./data_processor_service/final_predictions:/app/data_processor_service/final_predictions:ro
      - ./data_processor_service/final_predictions:/app/final_predictions:ro
    environment:
      - FLASK_ENV=production
      - PYTHONUNBUFFERED=1
      - MARKET_DATA_SERVICE_URL=http://market_data_service:8001/api
    networks:
      - tradesystem_network
    restart: unless-stopped
    depends_on:
      - data_processor_service
      - market_data_service

  # Frontend Service
  frontend_service:
    build:
      context: .
      dockerfile: frontend_service/Dockerfile
    container_name: tradesystem_frontend
    ports:
      - "3000:80"
    depends_on:
      - api_service
      - market_data_service
    environment:
      - REACT_APP_API_URL=http://localhost:8000/api
      - REACT_APP_MARKET_DATA_API=http://localhost:8001/api
      - REACT_APP_WS_URL=ws://localhost:8000
    networks:
      - tradesystem_network
    restart: unless-stopped

  # Scheduler Service
  scheduler_service:
    build:
      context: .
      dockerfile: scheduler_service/Dockerfile
    container_name: tradesystem_scheduler
    volumes:
      - ./data_processor_service/final_predictions:/app/data_processor_service/final_predictions
    environment:
      - PYTHONUNBUFFERED=1
      - LOG_LEVEL=INFO
      - PREDICTIONS_DIR=/app/data_processor_service/final_predictions
    depends_on:
      - data_processor_service
    networks:
      - tradesystem_network
    restart: unless-stopped

networks:
  tradesystem_network:
    driver: bridge