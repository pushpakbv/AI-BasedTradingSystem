version: '3.8'

services:
  # Continuous Crawler Service
  crawler_service:
    build:
      context: .
      dockerfile: crawler_service/Dockerfile
    container_name: tradesystem_crawler
    volumes:
      # Mount crawler data directory - THIS IS CRITICAL
      - ./crawler_service/data:/app/crawler_service/data
      # Mount config for live updates
      - ./crawler_service/config:/app/crawler_service/config:ro
    environment:
      - PYTHONUNBUFFERED=1
      - CRAWLER_INTERVAL_MINUTES=30
      - LOG_LEVEL=INFO
    networks:
      - tradesystem_network
    restart: unless-stopped

  # Continuous Data Processor Service
  data_processor_service:
    build:
      context: ./data_processor_service
      dockerfile: Dockerfile
      args:
        BUILDKIT_STEP_LOG_MAX_SIZE: -1
        BUILDKIT_STEP_LOG_MAX_SPEED: -1
    container_name: tradesystem_processor
    volumes:
      # Mount processor output directories - BIND MOUNTS for easy access
      - ./data_processor_service/final_predictions:/app/data_processor_service/final_predictions
      - ./data_processor_service/sentiment_results:/app/data_processor_service/sentiment_results
      - ./data_processor_service/financial_analysis_results:/app/data_processor_service/financial_analysis_results
      - ./data_processor_service/classified_articles:/app/data_processor_service/classified_articles
      # Mount crawler data as READ-ONLY - SHARED WITH CRAWLER
      - ./crawler_service/data:/app/crawler_service/data:ro
      # ADD: Share final_predictions at root for API compatibility
      - ./data_processor_service/final_predictions:/app/final_predictions
    environment:
      - PYTHONUNBUFFERED=1
      - PROCESSOR_CHECK_INTERVAL_SECONDS=60
      - LOG_LEVEL=INFO
    networks:
      - tradesystem_network
    restart: unless-stopped
    depends_on:
      - crawler_service

  # Market Data Service
  market_data_service:
    build:
      context: .
      dockerfile: market_data_service/Dockerfile
    container_name: tradesystem_market_data
    ports:
      - "8001:8001"
    volumes:
      # Mount market data directory - BIND MOUNT for easy access
      - ./market_data_service/stock_data:/app/market_data_service/stock_data
    environment:
      - PYTHONUNBUFFERED=1
      - FLASK_ENV=production
      - FLASK_DEBUG=False
      - PORT=8001
      - LOG_LEVEL=INFO
    networks:
      - tradesystem_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # API Service with WebSocket
  api_service:
    build:
      context: .
      dockerfile: api_service/Dockerfile
    container_name: tradesystem_api
    ports:
      - "8000:8000"
    volumes:
      # Mount all data directories as READ-ONLY - using bind mounts
      - ./data_processor_service/final_predictions:/data_processor_service/final_predictions:ro
      - ./data_processor_service/sentiment_results:/app/data_processor_service/sentiment_results:ro
      - ./data_processor_service/financial_analysis_results:/app/data_processor_service/financial_analysis_results:ro
      - ./market_data_service/stock_data:/app/market_data_service/stock_data:ro
      # ADD: Mount final_predictions at /app/data_processor_service/final_predictions for Python API compatibility
      - ./data_processor_service/final_predictions:/app/data_processor_service/final_predictions:ro
      # ADD: Mount final_predictions at /app/final_predictions for direct access if needed
      - ./data_processor_service/final_predictions:/app/final_predictions:ro
    environment:
      - FLASK_ENV=production
      - PYTHONUNBUFFERED=1
      - MARKET_DATA_SERVICE_URL=http://market_data_service:8001/api
    networks:
      - tradesystem_network
    restart: unless-stopped
    depends_on:
      - data_processor_service
      - market_data_service

  # Frontend Service
  frontend_service:
    build:
      context: .
      dockerfile: frontend_service/Dockerfile
    container_name: tradesystem_frontend
    ports:
      - "3000:80"
    depends_on:
      - api_service
      - market_data_service
    environment:
      # These are for browser-side API calls (localhost works because browser is on host machine)
      - REACT_APP_API_URL=http://localhost:8000/api
      - REACT_APP_MARKET_DATA_API=http://localhost:8001/api
      - REACT_APP_WS_URL=ws://localhost:8000
      # IMPORTANT: For build-time API calls within container, use service names
      - REACT_APP_INTERNAL_API_URL=http://api_service:8000/api
      - REACT_APP_INTERNAL_MARKET_DATA_API=http://market_data_service:8001/api
    networks:
      - tradesystem_network
    restart: unless-stopped

networks:
  tradesystem_network:
    driver: bridge